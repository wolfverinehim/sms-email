import smtplib
import ssl
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from email.utils import formataddr
import getpass
import sys
import os
import configparser

def verificar_configuracion_existente():
    """Verifica si ya existe una configuraci√≥n v√°lida"""
    config_path = os.path.join('..', 'config.ini')
    
    if not os.path.exists(config_path):
        return False, None
    
    try:
        config = configparser.ConfigParser()
        config.read(config_path, encoding='utf-8')
        
        usuario = config.get('gmail', 'usuario', fallback='')
        password = config.get('gmail', 'password', fallback='')
        
        if usuario and password:
            print(f"üìÇ Configuraci√≥n encontrada en config.ini")
            print(f"üë§ Usuario: {usuario}")
            respuesta = input("¬øQuieres usar esta configuraci√≥n? (s/n): ").strip().lower()
            
            if respuesta in ['s', 'si', 's√≠', 'y', 'yes']:
                gmail_config = {
                    'host': config.get('gmail', 'host', fallback='smtp.gmail.com'),
                    'puerto': config.getint('gmail', 'puerto', fallback=587),
                    'usuario': usuario,
                    'password': password
                }
                return True, gmail_config
        
        return False, None
        
    except Exception as e:
        print(f"‚ö†Ô∏è  Error leyendo config.ini: {e}")
        return False, None

def obtener_credenciales():
    """Obtiene las credenciales de forma segura"""
    print("üîê CONFIGURACI√ìN DE CREDENCIALES GMAIL")
    print("-" * 50)
    
    # Usuario
    usuario = input(f"üìß Usuario Gmail: ").strip()
    if not usuario:
        print("‚ùå Debes introducir un email de Gmail")
        return None, None
    
    if not usuario.endswith('@gmail.com'):
        print("‚ö†Ô∏è  Nota: Aseg√∫rate de usar un email @gmail.com")
    
    print("\nüí° IMPORTANTE:")
    print("   - NO uses tu contrase√±a normal de Gmail")
    print("   - USA una 'Contrase√±a de aplicaci√≥n' de 16 caracteres")
    print("   - Genera una en: https://myaccount.google.com/apppasswords")
    
    # Contrase√±a de aplicaci√≥n
    password = getpass.getpass("\nüîë Contrase√±a de aplicaci√≥n (16 caracteres): ")
    
    if len(password) != 16:
        print("‚ö†Ô∏è  La contrase√±a de aplicaci√≥n debe tener exactamente 16 caracteres")
    
    return usuario, password

def probar_conexion_gmail(usuario, password):
    """Prueba la conexi√≥n b√°sica con Gmail SMTP"""
    print("\nüîó PROBANDO CONEXI√ìN CON GMAIL...")
    print("-" * 50)
    
    config = {
        'host': 'smtp.gmail.com',
        'puerto': 587,
        'usuario': usuario,
        'password': password
    }
    
    try:
        print(f"üì° Conectando a {config['host']}:{config['puerto']}")
        servidor = smtplib.SMTP(config['host'], config['puerto'])
        
        print("üîê Iniciando TLS...")
        servidor.starttls()
        
        print("üë§ Intentando login...")
        servidor.login(config['usuario'], config['password'])
        
        print("‚úÖ ¬°CONEXI√ìN EXITOSA!")
        servidor.quit()
        return True, config
        
    except smtplib.SMTPAuthenticationError as e:
        print(f"‚ùå ERROR DE AUTENTICACI√ìN: {e}")
        print("\nüí° VERIFICA:")
        print("1. ¬øActivaste la verificaci√≥n en 2 pasos?")
        print("2. ¬øGeneraste una contrase√±a de aplicaci√≥n?")
        print("3. ¬øUsaste la contrase√±a de aplicaci√≥n (no la normal)?")
        print("4. ¬øLa contrase√±a tiene exactamente 16 caracteres?")
        return False, None
        
    except Exception as e:
        print(f"‚ùå ERROR: {e}")
        return False, None

def enviar_email_prueba(config, destino):
    """Env√≠a un email de prueba"""
    print(f"\nüìß ENVIANDO EMAIL DE PRUEBA A: {destino}")
    print("-" * 50)
    
    try:
        # Crear mensaje
        mensaje = MIMEMultipart('alternative')
        mensaje['From'] = formataddr(('Sistema SMS/Email ‚úÖ', config['usuario']))
        mensaje['To'] = destino
        mensaje['Subject'] = "‚úÖ Configuraci√≥n Gmail Exitosa - Sistema SMS/Email"
        
        # Contenido HTML mejorado
        html = f"""
        <html>
            <head>
                <style>
                    body {{ font-family: Arial, sans-serif; line-height: 1.6; color: #333; }}
                    .header {{ background: linear-gradient(135deg, #4CAF50, #45a049); color: white; padding: 20px; text-align: center; border-radius: 10px 10px 0 0; }}
                    .content {{ padding: 20px; background: #f9f9f9; }}
                    .success-box {{ background: #d4edda; border: 1px solid #c3e6cb; padding: 15px; border-radius: 5px; margin: 15px 0; }}
                    .config-box {{ background: #e2e3e5; border: 1px solid #d6d8db; padding: 15px; border-radius: 5px; margin: 15px 0; }}
                    .footer {{ background: #6c757d; color: white; padding: 10px; text-align: center; border-radius: 0 0 10px 10px; font-size: 12px; }}
                    .command {{ background: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; border-radius: 3px; font-family: monospace; word-break: break-all; }}
                </style>
            </head>
            <body>
                <div class="header">
                    <h1>üéâ ¬°Configuraci√≥n Exitosa!</h1>
                    <p>Tu sistema de env√≠o de emails est√° funcionando correctamente</p>
                </div>
                
                <div class="content">
                    <div class="success-box">
                        <h3>‚úÖ Conexi√≥n Gmail Establecida</h3>
                        <p>La autenticaci√≥n con Gmail fue exitosa usando contrase√±a de aplicaci√≥n.</p>
                    </div>
                    
                    <h3>üìã Configuraci√≥n Utilizada:</h3>
                    <div class="config-box">
                        <strong>Servidor SMTP:</strong> {config['host']}<br>
                        <strong>Puerto:</strong> {config['puerto']}<br>
                        <strong>Seguridad:</strong> TLS<br>
                        <strong>Usuario:</strong> {config['usuario']}<br>
                        <strong>Autenticaci√≥n:</strong> Contrase√±a de aplicaci√≥n ‚úÖ
                    </div>
                    
                    <h3>üöÄ Comando para usar en tu script:</h3>
                    <div class="command">
python src/envio_sms_email.py EMAIL "{destino}" "&lt;h1&gt;Tu mensaje&lt;/h1&gt;" "587" "{config['usuario']}" "tu_contrase√±a_app" "smtp.gmail.com" "True"
                    </div>
                    
                    <h3>üì¶ Comando con ejecutable:</h3>
                    <div class="command">
dist/IBA-SoftEnvioSMS.exe EMAIL "{destino}" "&lt;h1&gt;Tu mensaje&lt;/h1&gt;" "587" "{config['usuario']}" "tu_contrase√±a_app" "smtp.gmail.com" "True"
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px;">
                        <strong>üîê Recuerda:</strong> Guarda tu contrase√±a de aplicaci√≥n de forma segura. No la compartas y √∫sala solo para esta aplicaci√≥n.
                    </div>
                </div>
                
                <div class="footer">
                    Sistema IBA-Soft SMS/Email - Configurado exitosamente el 2 de julio de 2025
                </div>
            </body>
        </html>
        """
        
        # Adjuntar contenido
        parte_html = MIMEText(html, 'html', 'utf-8')
        mensaje.attach(parte_html)
        
        # Enviar email
        servidor = smtplib.SMTP(config['host'], config['puerto'])
        servidor.starttls()
        servidor.login(config['usuario'], config['password'])
        
        servidor.sendmail(config['usuario'], destino, mensaje.as_string())
        servidor.quit()
        
        print("‚úÖ EMAIL ENVIADO CORRECTAMENTE")
        print(f"üì® Revisa la bandeja de entrada de: {destino}")
        return True
        
    except Exception as e:
        print(f"‚ùå ERROR AL ENVIAR EMAIL: {e}")
        return False

def guardar_configuracion(config):
    """Guarda la configuraci√≥n en config.ini en la ra√≠z del proyecto"""
    try:
        config_path = os.path.join('..', 'config.ini')
        config_content = f"""# Archivo de configuraci√≥n para IBA-Soft Env√≠o SMS/Email
# IMPORTANTE: Este archivo contiene credenciales sensibles
# NO subir este archivo a repositorios p√∫blicos

[gmail]
usuario = {config['usuario']}
password = {config['password']}
host = {config['host']}
puerto = {config['puerto']}
ssl = True

[sms]
puerto_default = COM3
baudrate = 9600
timeout = 5

[sistema]
directorio_logs = logs
nivel_log = INFO
rotacion_logs_dias = 30
"""
        
        with open(config_path, 'w', encoding='utf-8') as f:
            f.write(config_content)
        
        print(f"\nüíæ Configuraci√≥n guardada en config.ini")
        print(f"üîê IMPORTANTE: Este archivo contiene credenciales sensibles")
        print(f"‚ö†Ô∏è  NO subir config.ini a repositorios p√∫blicos")
        
    except Exception as e:
        print(f"‚ùå Error guardando configuraci√≥n: {e}")

def main():
    print("üîß CONFIGURADOR SEGURO DE EMAIL GMAIL")
    print("=" * 60)
    
    # Verificar si ya existe configuraci√≥n
    config_existente, config = verificar_configuracion_existente()
    
    if config_existente:
        # Usar configuraci√≥n existente
        print("‚úÖ Usando configuraci√≥n existente")
        usuario = config['usuario']
        password = config['password']
    else:
        # Obtener credenciales nuevas
        usuario, password = obtener_credenciales()
        
        if not usuario or not password:
            print("\n‚ùå Credenciales inv√°lidas")
            return
    
    # Probar conexi√≥n
    exito, config = probar_conexion_gmail(usuario, password)
    
    if not exito:
        print("\n‚ùå No se pudo establecer conexi√≥n.")
        print("\nüìñ Lee la gu√≠a: docs/CONFIGURAR_GMAIL.md")
        
        # Si hab√≠a configuraci√≥n existente pero fall√≥, ofrecer reconfigurar
        if config_existente:
            print("\nüîÑ ¬øQuieres introducir nuevas credenciales? (s/n): ", end="")
            if input().strip().lower() in ['s', 'si', 's√≠', 'y', 'yes']:
                usuario, password = obtener_credenciales()
                if usuario and password:
                    exito, config = probar_conexion_gmail(usuario, password)
        
        if not exito:
            return
    
    # Pedir email de destino
    print(f"\nüìß ¬øA qu√© email enviar la prueba?")
    destino = input("Email destino (ENTER para usar el mismo): ").strip()
    
    if not destino:
        destino = usuario
    
    # Enviar email de prueba
    if enviar_email_prueba(config, destino):
        print("\nüéâ ¬°CONFIGURACI√ìN COMPLETA Y EXITOSA!")
        
        # Guardar configuraci√≥n solo si es nueva o ha cambiado
        if not config_existente:
            guardar_configuracion(config)
        
        # Mostrar comandos de ejemplo
        print(f"\nüéØ COMANDOS DE EJEMPLO:")
        print(f"\nüìß Email simple (Python):")
        print(f'python src/envio_sms_email.py EMAIL "{destino}" "Mensaje de prueba" "587" "{usuario}" "tu_contrase√±a_app" "smtp.gmail.com" "True"')
        
        print(f"\nüìß Email HTML (Python):")
        print(f'python src/envio_sms_email.py EMAIL "{destino}" "<h1>T√≠tulo</h1><p>Contenido HTML</p>" "587" "{usuario}" "tu_contrase√±a_app" "smtp.gmail.com" "True"')
        
        print(f"\nüì¶ Con ejecutable:")
        print(f'dist/IBA-SoftEnvioSMS.exe EMAIL "{destino}" "<h1>T√≠tulo</h1>" "587" "{usuario}" "tu_contrase√±a_app" "smtp.gmail.com" "True"')
        
        print(f"\nüîó Script interactivo:")
        print(f'scripts/usar_IBA-SoftEnvioSMS.bat')
        
        print(f"\n‚úÖ ¬°Tu sistema est√° listo para usar!")
    
    else:
        print(f"\n‚ùå Error enviando email de prueba")

if __name__ == "__main__":
    main()
